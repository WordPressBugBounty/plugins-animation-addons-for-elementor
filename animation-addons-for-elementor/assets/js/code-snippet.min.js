let editor,escButton,isDarkTheme=!1,isFullscreen=!1;const languageModes={html:"htmlmixed",css:"css",javascript:"javascript",php:"application/x-httpd-php"},exampleCode={html:"<h1>Code is Poetry.</h1>",css:"/* CSS Example */\n.button {\n    background: #007cba;\n    color: white;\n    padding: 10px 20px;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n    transition: background 0.3s ease;\n}\n\n.button:hover {\n    background: #005a87;\n}",javascript:"// JavaScript Example\ndocument.addEventListener('DOMContentLoaded', function() {\n    console.log('Code is Poetry.');\n});",php:"<?php\n// PHP Example\nadd_filter( 'the_title', 'convert_smilies' );\nadd_filter( 'wp_title', 'convert_smilies' );\nadd_filter( 'sanitize_file_name', 'mb_strtolower' );"};function createEscButton(){const e=document.createElement("style");e.textContent='\n    .CodeMirror.fullscreen {\n        position: fixed !important;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        width: 100% !important;\n        height: 100% !important;\n        z-index: 9999;\n        background: #fff;\n    }\n\n    .CodeMirror.fullscreen.cm-s-material {\n        background: #263238;\n    }\n\n    .fullscreen-esc-button {\n        position: fixed;\n        top: 40px;\n        right: 15px;\n        z-index: 10000;\n        background: rgba(0, 0, 0, 0.7);\n        color: white;\n        border: 1px solid #555;\n        border-radius: 6px;\n        padding: 8px 16px;\n        cursor: pointer;\n        font-family: monospace;\n        font-size: 12px;\n        font-weight: bold;\n        display: none;\n        transition: all 0.2s ease;\n        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);\n    }\n\n    .fullscreen-esc-button:hover {\n        background: rgba(0, 0, 0, 0.9);\n        transform: translateY(-1px);\n    }\n\n    .fullscreen-esc-button.show {\n        display: block;\n    }\n\n    .fullscreen-esc-button::before {\n        content: "âŽ‹ ";\n        margin-right: 4px;\n    }\n    ',document.head.appendChild(e),escButton=document.createElement("button"),escButton.className="fullscreen-esc-button",escButton.innerHTML="ESC",escButton.title="Exit Fullscreen (ESC key)",document.body.appendChild(escButton),escButton.addEventListener("click",function(){isFullscreen&&exitFullscreen()})}function initializeEditor(){const e=document.getElementById("wp-code-editor-container"),t=document.getElementById("code-content-hidden"),n=document.getElementById("code-type");if(!e)return void console.warn("Editor container not found");const i=t&&t.value||"",o=detectCodeType(i);n&&i&&(n.value=o);const r=languageModes[o]||languageModes.html;editor=CodeMirror(e,{value:i,mode:r,theme:"default",lineNumbers:!0,lineWrapping:!0,indentUnit:4,tabSize:4,indentWithTabs:!1,autoCloseBrackets:!0,autoCloseTags:!0,matchBrackets:!0,matchTags:!0,styleActiveLine:!0,showCursorWhenSelecting:!0,scrollbarStyle:"native",viewportMargin:1/0,cursorBlinkRate:530,dragDrop:!0,foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-lint-markers","CodeMirror-foldgutter"],extraKeys:{"Ctrl-Space":"autocomplete",F11:toggleFullscreen,Esc:exitFullscreen,"Ctrl-/":"toggleComment","Ctrl-D":"deleteLine","Ctrl-]":"indentMore","Ctrl-[":"indentLess","Ctrl-F":"find",F3:"findNext","Shift-F3":"findPrev","Ctrl-H":"replace","Ctrl-G":"jumpToLine","Ctrl-A":"selectAll","Ctrl-L":"selectLine","Alt-Up":function(e){var t=e.getCursor();if(t.line>0){var n=e.getLine(t.line),i=e.getLine(t.line-1);e.replaceRange(n+"\n"+i,{line:t.line-1,ch:0},{line:t.line+1,ch:0}),e.setCursor(t.line-1,t.ch)}},"Alt-Down":function(e){var t=e.getCursor();if(t.line<e.lineCount()-1){var n=e.getLine(t.line),i=e.getLine(t.line+1);e.replaceRange(i+"\n"+n,{line:t.line,ch:0},{line:t.line+2,ch:0}),e.setCursor(t.line+1,t.ch)}},"Ctrl-Shift-D":function(e){var t=e.getCursor(),n=e.getLine(t.line);e.replaceRange("\n"+n,{line:t.line,ch:e.getLine(t.line).length}),e.setCursor(t.line+1,t.ch)}},tabSize:4,readOnly:!1,matchBrackets:!0,styleActiveLine:!0,showCursorWhenSelecting:!0,scrollbarStyle:"native",viewportMargin:1/0,cursorBlinkRate:530,dragDrop:!0,hintOptions:{completeSingle:!1,alignWithWord:!0},value:t&&t.value||""}),setTimeout(function(){editor&&(editor.refresh(),editor.setOption("mode",r))},100),t&&editor.on("change",function(){t.value=editor.getValue(),updateStats()}),updateStats()}function detectCodeType(e){if(!e||""===e.trim()){const e=document.getElementById("code-type");return e?e.value:"html"}if(e.includes("<?php")||e.includes("<?="))return"php";if(/<\/?[a-z][\s\S]*>/i.test(e))return e.includes("{")&&e.includes("}")&&e.includes(":")&&!e.includes("<style>")?"css":"html";if(e.includes("function")||e.includes("var ")||e.includes("let ")||e.includes("const ")||e.includes("=>"))return"javascript";if(e.includes("{")&&e.includes("}")&&e.includes(":"))return"css";const t=document.getElementById("code-type");return t?t.value:"html"}function changeLanguageMode(e){if(!editor)return;const t=languageModes[e];editor.setOption("mode",t);const n=document.getElementById("language-indicator");n&&(n.textContent=e.toUpperCase()),showNotification(`Switched to ${e.toUpperCase()} mode`)}function updateStats(){if(!editor)return;const e=editor.getValue(),t=editor.lineCount(),n=e.length,i=e.trim()?e.trim().split(/\s+/).length:0,o=document.getElementById("editor-stats");o&&(o.innerHTML=`Lines: ${t} | Characters: ${n} | Words: ${i}`)}function toggleTheme(){if(!editor)return;isDarkTheme=!isDarkTheme;const e=isDarkTheme?"material":"default";editor.setOption("theme",e),showNotification(`Switched to ${isDarkTheme?"dark":"light"} theme`)}function toggleFullscreen(){if(!editor)return;isFullscreen=!isFullscreen;const e=editor.getWrapperElement();isFullscreen?(e.classList.add("fullscreen"),editor.setSize("100%","100vh"),escButton&&escButton.classList.add("show"),editor.focus()):exitFullscreen(),editor.refresh(),showNotification(isFullscreen?"Entered fullscreen mode - Press ESC to exit":"Exited fullscreen")}function exitFullscreen(){if(!editor||!isFullscreen)return;isFullscreen=!1;editor.getWrapperElement().classList.remove("fullscreen"),editor.setSize("100%","500px"),escButton&&escButton.classList.remove("show"),editor.refresh(),showNotification("Exited fullscreen mode")}async function copyCode(){if(!editor)return;const e=editor.getValue();try{await navigator.clipboard.writeText(e),showNotification("Code copied to clipboard!")}catch(t){const n=document.createElement("textarea");n.value=e,document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n),showNotification("Code copied to clipboard!")}}function downloadCode(){if(!editor)return;const e=editor.getValue(),t=document.getElementById("code-type");if(!t)return;const n=t.value,i=new Blob([e],{type:"text/plain"}),o=URL.createObjectURL(i),r=document.createElement("a");r.href=o,r.download=`code-snippet.${{html:"html",css:"css",javascript:"js",php:"php"}[n]}`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),showNotification("Code downloaded successfully!")}function insertExample(){if(!editor)return;const e=document.getElementById("code-type");if(!e)return;const t=e.value;let n=exampleCode[t];"php"!==t||n.trim().startsWith("<?php")||(n="<?php\n"+n),editor.setValue(n),showNotification(`${t.toUpperCase()} example inserted!`)}function showNotification(e){const t=document.createElement("div");t.className="notification",t.textContent=e,t.style.cssText="\n        position: fixed;\n        top: 40px;\n        right: 24%;\n        background: #333;\n        color: white;\n        padding: 10px 16px;\n        border-radius: 4px;\n        font-size: 14px;\n        z-index: 10001;\n        opacity: 0;\n        transition: opacity 0.3s ease;\n        box-shadow: 0 2px 10px rgba(0,0,0,0.2);\n    ",document.body.appendChild(t),setTimeout(()=>t.style.opacity="1",10),setTimeout(()=>{t.style.opacity="0",setTimeout(()=>{t.parentNode&&document.body.removeChild(t)},300)},3e3)}function updatePriorityValue(e){const t=document.getElementById("priority-value");t&&(t.value=e)}function initializeEditorFunctionality(){createEscButton(),initializeEditor();const e=document.getElementById("code-type");e&&e.addEventListener("change",function(){confirm("Switching code type will clear the editor. Continue?")?(changeLanguageMode(this.value),"php"===this.value?editor&&editor.setValue("<?php\n\n"):editor&&editor.setValue(""),showNotification(`Editor cleared for ${this.value.toUpperCase()} mode`)):editor&&(this.value=editor.getOption("mode"))});const t=document.getElementById("theme-toggle-btn");t&&t.addEventListener("click",toggleTheme);const n=document.getElementById("fullscreen-btn");n&&n.addEventListener("click",toggleFullscreen);const i=document.getElementById("copy-code-btn");i&&i.addEventListener("click",copyCode);const o=document.getElementById("download-code-btn");o&&o.addEventListener("click",downloadCode);const r=document.getElementById("insert-example-btn");r&&r.addEventListener("click",insertExample),document.addEventListener("keydown",function(e){"Escape"===e.key&&isFullscreen&&exitFullscreen(),e.ctrlKey&&"t"===e.key&&!e.shiftKey&&(e.preventDefault(),toggleTheme())})}function initializeLocationToggle(){const e=document.getElementById("code-type"),t=document.getElementById("load-location-group"),n=document.getElementById("php-version-notice");function i(){"php"===e.value?(t.style.display="none",n.style.display=""):(t.style.display="",n.style.display="none")}e&&t&&n&&(i(),e.addEventListener("change",i))}function initializeVisibilityPageToggle(){const e=document.getElementById("visibility-page"),t=document.getElementById("visibility-page-list");if(!e||!t)return;const n=t.closest(".form-subgroup");function i(){"specifics"!==e.value?n.style.display="none":n.style.display=""}n&&(i(),e.addEventListener("change",i))}function initializePrioritySlider(){const e=document.getElementById("priority-slider"),t=document.getElementById("priority-value");function n(n){let i=parseInt(n,10);isNaN(i)||i<1?i=1:i>999&&(i=999),e&&(e.value=i),t&&(t.value=i)}e&&e.addEventListener("input",function(){var e;e=this.value,t&&(t.value=e)}),t&&(t.addEventListener("input",function(){n(this.value)}),t.addEventListener("blur",function(){n(this.value)}),t.addEventListener("keypress",function(e){"Enter"===e.key&&(n(this.value),this.blur())}));const i=document.getElementById("priority-slider"),o=document.getElementById("priority-value");i&&o&&(o.textContent=i.value,i.addEventListener("input",function(){o.textContent=this.value}))}function initializePHPVersionCheck(){const e=document.querySelector('[name="code_type"]'),t=document.querySelector('[name="code_content"]');if(!e||!t)return;if("undefined"==typeof WCFCustomCodeVars||!WCFCustomCodeVars.serverDetails||!WCFCustomCodeVars.serverDetails.currentVersion)return void console.warn("WCFCustomCodeVars not found or missing serverDetails");const n=WCFCustomCodeVars.serverDetails.currentVersion;function i(){if(e&&"php"===e.value){let e=document.getElementById("php-version-notice");e&&(e.innerHTML=`Server is running <strong>PHP ${n}</strong>. Please ensure your code is compatible.`)}}const o=[{regex:/void\s+function/,min:7.1,name:"void return type"},{regex:/iterable\s+function/,min:7.1,name:"iterable type"},{regex:/public\s+const|private\s+const|protected\s+const/,min:7.1,name:"Visibility on class constants"},{regex:/\?\?=/,min:7.4,name:"Null coalescing assignment (??=)"},{regex:/object\s+\$[A-Za-z_]/,min:7.2,name:"object type hint"},{regex:/(?<!::)count\(/,min:7.2,name:"count() with Countable objects"},{regex:/stream_isatty\s*\(/,min:7.2,name:"stream_isatty() function"},{regex:/array_key_first\s*\(/,min:7.3,name:"array_key_first()"},{regex:/array_key_last\s*\(/,min:7.3,name:"array_key_last()"},{regex:/hrtime\s*\(/,min:7.3,name:"hrtime() function"},{regex:/fn\s*\(.*\)\s*=>/,min:7.4,name:"Arrow functions"},{regex:/[A-Za-z0-9_]+\s*\??:\s*[A-Za-z0-9_]+/,min:7.4,name:"Nullable property types"},{regex:/[A-Za-z0-9_]+\s+:\s*[A-Za-z0-9_]+(\s*\|[A-Za-z0-9_]+)+/,min:8,name:"Union types (PHP 8.0, but check early)"},{regex:/Typed property/,min:7.4,name:"Typed properties"},{regex:/match\s*\(/,min:8,name:"match expression"},{regex:/#[A-Za-z0-9_]+/,min:8,name:'Attributes syntax (#[])"'},{regex:/str_contains\s*\(/,min:8,name:"str_contains()"},{regex:/str_starts_with\s*\(/,min:8,name:"str_starts_with()"},{regex:/str_ends_with\s*\(/,min:8,name:"str_ends_with()"},{regex:/get_debug_type\s*\(/,min:8,name:"get_debug_type()"},{regex:/fdiv\s*\(/,min:8,name:"fdiv()"},{regex:/throw\s+\S+/,min:8,name:"throw as expression"},{regex:/static\s+function\s*\(/,min:8,name:"Static anonymous functions"},{regex:/readonly\s+/,min:8.1,name:"Readonly properties"},{regex:/enum\s+[A-Za-z_]/,min:8.1,name:"Enums"},{regex:/fibers?/i,min:8.1,name:"Fibers API"},{regex:/never\s+function/,min:8.1,name:"never return type"},{regex:/array_is_list\s*\(/,min:8.1,name:"array_is_list()"},{regex:/readonly\s+class/,min:8.2,name:"Readonly classes"},{regex:/true\s*\|\s*false/,min:8.2,name:"true/false as standalone types"},{regex:/null\s*\|/,min:8.2,name:"null as standalone type"},{regex:/#[A-Za-z0-9_]+\(.+\)/,min:8.2,name:"Disjunctive Normal Form types (DNF)"},{regex:/json_validate\s*\(/,min:8.3,name:"json_validate()"},{regex:/#[A-Za-z0-9_]+\(.+\)/,min:8.3,name:"Explicitly negative keys in array destructuring"},{regex:/array_find\s*\(/,min:8.4,name:"array_find()"},{regex:/array_all\s*\(/,min:8.4,name:"array_all()"},{regex:/array_any\s*\(/,min:8.4,name:"array_any()"},{regex:/\{\s*get\s*=>/,min:8.4,name:"Property hooks"}];function r(){const e=t.value,i=parseFloat(n);let r=!1;return o.forEach(t=>{i<t.min&&t.regex.test(e)&&(alert(`Your code uses ${t.name}, which requires PHP ${t.min}+ but the server is running PHP ${n}.`),r=!0)}),!r}i(),r(),e.addEventListener("change",i);const s=document.querySelector("form");s&&s.addEventListener("submit",function(e){r()||e.preventDefault()})}function initializeSelect2PageSelection(){"undefined"!=typeof jQuery&&jQuery("#visibility-page-list").length&&jQuery("#visibility-page-list").select2({ajax:{url:ajaxurl,dataType:"json",method:"post",delay:250,data:function(e){return{q:e.term,page:e.page||1,action:"add_custom_page",nonce:WCFCustomCodeVars.nonce}},processResults:function(e){let t=[],n=new Set;return e.forEach(e=>{n.has(e.id)||(n.add(e.id),t.push(e))}),{results:t}},cache:!0},minimumInputLength:2,placeholder:"Search and select an option",allowClear:!0})}function initializeVisibilityOptions(){const e=document.getElementById("code-type"),t=document.getElementById("visibility-page");if(!e||!t)return;const n=t.innerHTML;function i(){const i=e.value,o=t.value;t.innerHTML="php"===i?'\n                <optgroup label="Basic">\n                    <option value="">None</option>\n                    <option value="global">Entire Website</option>\n                    <option value="frontend">Frontend</option>\n                    <option value="admin">Backend</option>\n                </optgroup>\n            ':n;Array.from(t.options).some(e=>e.value===o)&&(t.value=o)}e.addEventListener("change",i),i(),window.addEventListener("load",function(){i()})}function initializeLoadLocationOptions(){const e=document.getElementById("code-type"),t=document.getElementById("load-location");function n(){const n=e.value;if(Array.from(t.options).forEach(e=>{e.disabled="javascript"===n&&!(""===e.value||"head"===e.value||"footer"===e.value)}),t.options[t.selectedIndex].disabled){const e=Array.from(t.options).find(e=>!e.disabled);e&&(t.value=e.value)}}e&&t&&(n(),e.addEventListener("change",n))}function initializeDependencyToggles(){const e=document.getElementById("load-location"),t=document.getElementById("visibility-page");function n(){const n=e.value,i=t.value,o=i.includes("archive")||"blog"===i;Array.from(t.options).forEach(e=>{(e.value.includes("archive")||"blog"===e.value)&&(e.disabled="content_before"===n||"content_after"===n)});const r=e.querySelector('option[value="content_before"]'),s=e.querySelector('option[value="content_after"]');o?(r&&(r.disabled=!0),s&&(s.disabled=!0),"content_before"!==n&&"content_after"!==n||(e.value="")):(r&&(r.disabled=!1),s&&(s.disabled=!1))}e&&t&&(n(),e.addEventListener("change",n),t.addEventListener("change",n))}function initializeActiveToggle(){const e=document.getElementById("active-toggle"),t=document.querySelector(".aae-csp-active__status");if(!e||!t)return;const n=t.querySelector("span");e&&t&&n&&e.addEventListener("change",function(){this.checked?(t.classList.remove("inactive"),n.textContent="Active"):(t.classList.add("inactive"),n.textContent="Inactive")})}document.addEventListener("DOMContentLoaded",function(){initializeEditorFunctionality(),initializeLocationToggle(),initializeVisibilityPageToggle(),initializePrioritySlider(),initializePHPVersionCheck(),initializeSelect2PageSelection(),initializeVisibilityOptions(),initializeLoadLocationOptions(),initializeDependencyToggles(),initializeActiveToggle(),setTimeout(function(){if(editor){editor.refresh();const e=editor.getOption("mode");editor.setOption("mode",e)}},500)});