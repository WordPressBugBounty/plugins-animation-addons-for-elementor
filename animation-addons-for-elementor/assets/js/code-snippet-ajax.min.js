!function(e){"use strict";var t={config:{ajaxInProgress:!1,searchTimeout:null,searchDelay:500},init:function(){this.bindEvents()},bindEvents:function(){var t=this;e("#search-submit").on("click",function(){clearTimeout(t.config.searchTimeout);var s=e("#snippet-search-input").val();const a=new URL(window.location.href);s.length>0?a.searchParams.set("s",s):a.searchParams.delete("s"),history.replaceState({},"",a.toString()),t.config.searchTimeout=setTimeout(function(){t.performAjaxSearch()},t.config.searchDelay)}),e(".subsubsub a").on("click",function(s){s.preventDefault(),e(".subsubsub a").removeClass("current"),e(this).addClass("current"),t.handleFilterChange(e(this))}),e(document).on("click",".ajax-delete-snippet",function(s){s.preventDefault(),t.handleSingleDelete(e(this))}),e(document).on("click","#ajax-delete-snippet",function(s){s.preventDefault(),t.handleSingleDeleteBtn(e(this))}),e("#doaction, #doaction2").on("click",function(s){s.preventDefault(),t.handleBulkAction(e(this))}),e(document).on("change",".snippet-status-toggle",function(){t.handleStatusToggle(e(this))})},performAjaxSearch:function(){if(this.config.ajaxInProgress)return;const s=new URLSearchParams(window.location.href);var a=e("#snippet-search-input").val(),o=s.get("code_type")||"all",n=s.get("paged")||1;this.config.ajaxInProgress=!0,e.ajax({url:WCFCustomCodeVars.ajaxurl,type:"POST",data:{action:WCFCustomCodeVars.ajaxActions.search,nonce:WCFCustomCodeVars.nonce,search:a,code_type:o,page:n,per_page:20},success:function(e){e.success?t.updateTableWithResults(e.data):t.showErrorMessage(e.data.message||WCFCustomCodeVars.messages.error)},error:function(){t.showErrorMessage(WCFCustomCodeVars.messages.error)},complete:function(){t.config.ajaxInProgress=!1}})},updateTableWithResults:function(t){var s=e(".wp-list-table tbody");if(s.empty(),0===t.snippets.length)return s.append('<tr><td colspan="8" class="no-items">No code snippets found.</td></tr>'),this.updateItemsCount(0),void this.updatePagination(t);var a=this;e.each(t.snippets,function(e,t){var o=a.createTableRow(t);s.append(o)}),this.updateItemsCount(t.total),this.updatePagination(t)},createTableRow:function(e){var t="code-type-"+(e.code_type||""),s=(e.code_type||"").toUpperCase().replace(/[-_]/g," "),a=(e.load_location||"").toUpperCase().replace(/[-_]/g," "),o="yes"===e.is_active?"checked":"";return'<tr><th scope="row" class="check-column"><input type="checkbox" name="ids[]" value="'+e.id+'" /></th><td class="name column-name"><strong><a href="'+e.edit_url+'">'+e.title+'</a></strong><div class="row-actions"><span class="edit"><a href="'+e.edit_url+'">Edit</a> | </span><span class="delete"><a href="#" class="ajax-delete-snippet" data-id="'+e.id+'">Delete</a></span></div></td><td class="code_type column-code_type"><span class="code-type '+t+'">'+s+'</span></td><td class="visibility_list column-visibility_list">'+e.visibility_list+'</td><td class="load_location column-load_location"><span class="load-location '+(a?"":"empty")+'">'+(a||"â€”")+'</span></td><td class="priority column-priority"><span class="priority priority-'+(e.priority||"10")+'">'+(e.priority||"10")+'</span></td><td class="snippet_status column-snippet_status"><label class="toggle-switch"><input type="checkbox" class="snippet-status-toggle" data-id="'+e.id+'" '+o+'><span class="slider"></span></label></td><td class="date_created column-date_created">'+e.date_modified+"</td></tr>"},updateItemsCount:function(t){e(".tablenav .displaying-num").text(t+" items"),e(".wp-list-table .subsubsub .count").each(function(){var s=e(this),a=s.text().replace(/\(\d+\)/,"("+t+")");s.text(a)})},updatePagination:function(t){var s=e(".tablenav-pages .pagination-links");t.total_pages>1?s.show():s.hide()},handleFilterChange:function(e){var t=e.attr("href");history.pushState({},"",t);new URLSearchParams(t.split("?")[1]).get("code_type");this.performAjaxSearch()},handleSingleDelete:function(s){if(!confirm(WCFCustomCodeVars.messages.confirmDelete))return!1;var a=s.data("id"),o=s.closest("tr");e.ajax({url:WCFCustomCodeVars.ajaxurl,type:"POST",data:{action:WCFCustomCodeVars.ajaxActions.delete,nonce:WCFCustomCodeVars.nonce,snippet_id:a},success:function(s){s.success?o.length>0?o.fadeOut(300,function(){e(this).remove(),t.showSuccessMessage(s.data.message)}):setTimeout(function(){const e=new URLSearchParams(window.location.href);e.delete("edit"),window.location.href=e},2e3):t.showErrorMessage(s.data.message||WCFCustomCodeVars.messages.error)},error:function(){t.showErrorMessage(WCFCustomCodeVars.messages.error)}})},handleSingleDeleteBtn:function(s){if(!confirm(WCFCustomCodeVars.messages.confirmDelete))return!1;var a=s.data("id");e.ajax({url:WCFCustomCodeVars.ajaxurl,type:"POST",data:{action:WCFCustomCodeVars.ajaxActions.delete,nonce:WCFCustomCodeVars.nonce,snippet_id:a},beforeSend:function(){e("#wcf-code-loading").show()},success:function(s){console.log(s),s.success?setTimeout(function(){t.showErrorMessage(s.data.message),e("#wcf-code-loading").hide(),window.location.href=WCFCustomCodeVars.snippet_page},2e3):(t.showErrorMessage(s.data.message||WCFCustomCodeVars.messages.error),e("#wcf-code-loading").hide())},error:function(){t.showErrorMessage(WCFCustomCodeVars.messages.error),e("#wcf-code-loading").hide()}})},handleBulkAction:function(s){var a;a="doaction"===s.attr("id")?e("#bulk-action-selector-top").val():"doaction2"===s.attr("id")?e("#bulk-action-selector-bottom").val():s.siblings("select").val();var o=e('input[name="ids[]"]:checked');if(0===o.length)return alert("Please select at least one snippet."),!1;if("delete"===a&&!confirm(WCFCustomCodeVars.messages.confirmBulkDelete))return!1;var n=[],i=[];o.each(function(){n.push(e(this).val()),i.push(e(this).closest("tr"))}),s.prop("disabled",!0).val("Processing..."),e.ajax({url:WCFCustomCodeVars.ajaxurl,type:"POST",data:{action:WCFCustomCodeVars.ajaxActions.bulk,nonce:WCFCustomCodeVars.nonce,bulk_action:a,snippet_ids:n},success:function(s){s.success?(t.showSuccessMessage(s.data.message),"delete"===a?t.animateBulkDelete(i):t.performAjaxSearch(),e("#cb-select-all-2, #cb-select-all-1").prop("checked",!1)):t.showErrorMessage(s.data.message||WCFCustomCodeVars.messages.error)},error:function(){t.showErrorMessage(WCFCustomCodeVars.messages.error)},complete:function(){s.prop("disabled",!1).val("Apply")}})},animateBulkDelete:function(e){var t=this,s=e.length,a=0;e.forEach(function(e,o){setTimeout(function(){e.addClass("deleting"),e.animate({opacity:0,height:0,paddingTop:0,paddingBottom:0,marginTop:0,marginBottom:0},400,function(){e.remove(),++a===s&&t.updateItemsCountAfterDelete(s)})},100*o)})},updateItemsCountAfterDelete:function(t){var s=parseInt(e(".tablenav .displaying-num").text().replace(/\D/g,""))||0,a=Math.max(0,s-t);this.updateItemsCount(a)},handleStatusToggle:function(t){var s=t.data("id"),a=t.is(":checked")?"yes":"no",o=this,n=!t.is(":checked");t.prop("disabled",!0);var i=t.closest("tr");i.addClass("updating"),e.ajax({url:WCFCustomCodeVars.ajaxurl,type:"POST",data:{action:WCFCustomCodeVars.ajaxActions.toggle,nonce:WCFCustomCodeVars.nonce,snippet_id:s,status:a},success:function(e){e.success?(o.showSuccessMessage(e.data.message),o.updateRowStatus(i,a)):(o.showErrorMessage(e.data.message||WCFCustomCodeVars.messages.error),t.prop("checked",n))},error:function(){o.showErrorMessage(WCFCustomCodeVars.messages.error),t.prop("checked",n)},complete:function(){t.prop("disabled",!1),i.removeClass("updating")}})},updateRowStatus:function(e,t){e.find(".snippet-status-toggle").prop("checked","yes"===t),"yes"===t?e.removeClass("snippet-inactive").addClass("snippet-active"):e.removeClass("snippet-active").addClass("snippet-inactive")},showLoadingState:function(){e(".wp-list-table tbody").html('<tr><td colspan="8" class="loading">'+WCFCustomCodeVars.messages.loading+"</td></tr>")},hideLoadingState:function(){},showErrorMessage:function(t){e(".wcf-admin-page-content .notice").remove();var s=e('<div class="notice notice-error is-dismissible"><p>'+t+"</p></div>");e(".wcf-admin-page-content").prepend(s),setTimeout(function(){s.fadeOut(300,function(){e(this).remove()})},8e3),s.on("click",".notice-dismiss",function(){s.fadeOut(300,function(){e(this).remove()})})},showSuccessMessage:function(t){e(".wcf-admin-page-content .notice").remove();var s=e('<div class="notice notice-success is-dismissible"><p>'+t+"</p></div>");e(".wcf-admin-page-content").prepend(s),setTimeout(function(){s.fadeOut(300,function(){e(this).remove()})},5e3),s.on("click",".notice-dismiss",function(){s.fadeOut(300,function(){e(this).remove()})})}};e(document).ready(function(){t.init()}),window.CodeSnippetAjax=t}(jQuery);