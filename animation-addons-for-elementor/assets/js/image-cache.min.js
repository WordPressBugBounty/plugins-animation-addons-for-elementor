document.addEventListener("DOMContentLoaded",()=>{const e=Object.assign({idleMs:6e3,maxConcurrency:8,simulateScroll:!0,scrollStep:800,dailyOnce:!0,apiUrls:[],apiUrl:"",debug:!1},window.AAE_EDITOR_PRELOAD||{}),t=(...t)=>{e.debug&&console.log("[AAE image-cache]",...t)};let n=!1,r=null;const s=()=>{r&&clearTimeout(r),n||(r=setTimeout(f,e.idleMs||6e3))};["mousemove","mousedown","keydown","wheel","touchstart","pointerdown"].forEach(e=>document.addEventListener(e,s,{passive:!0})),document.addEventListener("visibilitychange",()=>{document.hidden||s()}),setTimeout(s,1e3);const a="aae_editor_preload_",o=(new Date).toISOString().slice(0,10),l=`${a}day_${o}`,i=(e,t)=>{try{localStorage.setItem(e,JSON.stringify(t))}catch(e){}},c=()=>!!((e,t=null)=>{try{const n=localStorage.getItem(e);return n?JSON.parse(n):t}catch(e){return t}})(l,!1),u=e=>Array.from(new Set(e.filter(Boolean))),m=()=>document.querySelector("#elementor-preview-iframe"),d=(e,t,n=300)=>{t.slice(0,n).forEach(t=>{try{((e,t)=>{try{const n=e.createElement("link");n.rel="prefetch",n.as="image",n.href=t,e.head.appendChild(n)}catch(e){}})(e,t)}catch(e){}try{const e=new Image;e.decoding="async",e.loading="eager",e.src=t}catch(e){}})},p=()=>new Promise(t=>{if(!(e.apiUrls&&e.apiUrls.length||e.apiUrl))return t([]);try{const n=(()=>{const e=new Blob(["\n      const uniq = (arr) => Array.from(new Set(arr.filter(Boolean)));\n\n      // Normalize any page JSON into a flat items array\n      const toItems = (json) => {\n        if (!json) return [];\n        if (Array.isArray(json)) return json;                // WP REST array\n        if (json.templates && Array.isArray(json.templates)) return json.templates; // themecrowdy\n        if (json.data && Array.isArray(json.data.templates)) return json.data.templates;\n        return [];\n      };\n\n      const extractWPUrls = (items) => {\n        const urls = [];\n        items.forEach(item => {\n          if (!item || typeof item !== 'object') return;\n          if (item.featured_media_url) urls.push(item.featured_media_url);\n          if (item.jetpack_featured_media_url) urls.push(item.jetpack_featured_media_url);\n          if (item.better_featured_image?.source_url) urls.push(item.better_featured_image.source_url);\n          if (item.meta?.preview_image) urls.push(item.meta.preview_image);\n          if (item.thumbnail) urls.push(item.thumbnail);\n\n          if (item.content?.rendered) {\n            const html = item.content.rendered;\n            let m;\n            const srcRe = /<img[^>]+src=[\"']([^\"']+)[\"']/gi;\n            while ((m = srcRe.exec(html)) !== null) { urls.push(m[1]); }\n\n            let n;\n            const ssRe = /srcset=[\"']([^\"']+)[\"']/gi;\n            while ((n = ssRe.exec(html)) !== null) {\n              n[1].split(',').forEach(p => {\n                const u = p.trim().split(/\\s+/)[0];\n                if (u) urls.push(u);\n              });\n            }\n          }\n        });\n        return urls;\n      };\n\n      const extractCrowdyUrls = (items) => {\n        const urls = [];\n        items.forEach(t => {\n          if (!t || typeof t !== 'object') return;\n\n          if (t.template_preview) urls.push(t.template_preview);\n          if (t.landing_image?.url) urls.push(t.landing_image.url);\n\n          const sizes = t.landing_image?.sizes || {};\n          Object.keys(sizes).forEach(k => {\n            const v = sizes[k];\n            if (typeof v === 'string' && /^https?:\\/\\//i.test(v)) urls.push(v);\n          });\n\n          if (t.content?.rendered) {\n            const html = t.content.rendered;\n            let m;\n            const srcRe = /<img[^>]+src=[\"']([^\"']+)[\"']/gi;\n            while ((m = srcRe.exec(html)) !== null) { urls.push(m[1]); }\n\n            let n;\n            const ssRe = /srcset=[\"']([^\"']+)[\"']/gi;\n            while ((n = ssRe.exec(html)) !== null) {\n              n[1].split(',').forEach(p => {\n                const u = p.trim().split(/\\s+/)[0];\n                if (u) urls.push(u);\n              });\n            }\n          }\n        });\n        return urls;\n      };\n\n      const fetchAllPages = async (baseUrl) => {\n        const out = [];\n        try {\n          const first = await fetch(baseUrl, { credentials: 'omit' });\n          if (!first.ok) return out;\n          const j1 = await first.json();\n          out.push(j1);\n\n          const totalPages = Math.min(parseInt(first.headers.get('X-WP-TotalPages') || '1', 10), 3);\n          for (let p = 2; p <= totalPages; p++) {\n            const url = baseUrl.replace(/([?&])page=\\d+/, '$1page=' + p) + (baseUrl.includes('page=') ? '' : (baseUrl.includes('?') ? '&' : '?') + 'page=' + p);\n            const r = await fetch(url, { credentials: 'omit' });\n            if (!r.ok) break;\n            const j = await r.json();\n            out.push(j);\n          }\n        } catch (err) {}\n        return out; // array of page JSONs\n      };\n\n      self.onmessage = async (e) => {\n        const { apiUrls = [], apiUrl = '' } = e.data || {};\n        try {\n          const endpoints = uniq([...(Array.isArray(apiUrls) ? apiUrls : []), apiUrl].filter(Boolean));\n          let allUrls = [];\n\n          for (const ep of endpoints) {\n            const pages = await fetchAllPages(ep);\n            for (const pageJson of pages) {\n              const items = toItems(pageJson);\n              const isCrowdy = !!(pageJson && pageJson.templates);\n              const urls = isCrowdy ? extractCrowdyUrls(items) : extractWPUrls(items);\n              allUrls.push(...urls);\n            }\n          }\n\n          postMessage({ urls: uniq(allUrls).filter(u => !/^data:/i.test(u)) });\n        } catch (err) {\n          postMessage({ urls: [] });\n        }\n      };\n    "],{type:"application/javascript"});return new Worker(URL.createObjectURL(e))})(),r=setTimeout(()=>{try{n.terminate()}catch(e){}t([])},25e3);n.onmessage=e=>{clearTimeout(r);try{n.terminate()}catch(e){}const s=Array.isArray(e.data?.urls)?e.data.urls:[];t(s)},n.postMessage({apiUrls:e.apiUrls||[],apiUrl:e.apiUrl||""})}catch(e){t([])}}),h=async()=>{const n=m(),r=!!n,s=await p();if(r){const r=(()=>{const e=m();return e&&(e.contentDocument||e.contentWindow?.document)})();if(!r||!r.body)return!1;e.simulateScroll&&await(async(e,t=800)=>{try{const{document:n}=e,r=Math.max(n.body.scrollHeight,n.documentElement.scrollHeight);for(let n=0;n<=r;n+=t)e.scrollTo(0,n),await new Promise(e=>setTimeout(e,16));e.scrollTo(0,0)}catch(e){}})(n.contentWindow,e.scrollStep||800);const{imgs:o,urls:l}=(e=>{const t=e.defaultView||window,n=[],r=Array.from(e.querySelectorAll("img"));return r.forEach(e=>{(e=>{try{e.loading="eager",e.decoding="async";const t=e.getAttribute("data-src"),n=e.getAttribute("data-srcset");t&&!e.src&&(e.src=t),n&&!e.getAttribute("srcset")&&e.setAttribute("srcset",n),!e.src&&e.currentSrc&&(e.src=e.currentSrc),(e.classList||{remove(){}}).remove("lazyloaded","lazyload","is-lazy")}catch(e){}})(e),e.currentSrc&&n.push(e.currentSrc),e.src&&n.push(e.src);const t=e.getAttribute("srcset");t&&t.split(",").forEach(e=>{const t=e.trim().split(/\s+/)[0];t&&n.push(t)})}),e.querySelectorAll("picture source[srcset]").forEach(e=>{const t=e.getAttribute("srcset");t&&t.split(",").forEach(e=>{const t=e.trim().split(/\s+/)[0];t&&n.push(t)})}),e.querySelectorAll("*").forEach(e=>{const r=((e,t)=>{try{const n=t.getComputedStyle(e).getPropertyValue("background-image"),r=/url\((?:"|')?(.*?)(?:"|')?\)/.exec(n),s=r&&r[1]?r[1]:null;return s&&!s.startsWith("data:")?s:null}catch(e){return null}})(e,t);r&&n.push(r)}),{imgs:r,urls:u(n).filter(e=>!e.startsWith("data:"))}})(r),c=u([...l,...s]);return d(r,c,300),await(async(e,t=8)=>{const n=e.slice(),r=new Array(Math.max(1,t)).fill(0).map(async()=>{for(;n.length;){const e=n.shift();try{"decode"in e?await e.decode():await new Promise(t=>{e.complete?t():e.addEventListener("load",t,{once:!0})})}catch(e){}}});await Promise.allSettled(r)})(o,e.maxConcurrency||8),i(`${a}last_report`,{at:Date.now(),mode:"editor",totalImgs:o.length,totalUrls:c.length}),t("editor preload complete",{totalImgs:o.length,totalUrls:c.length}),!0}return d(document,s,300),i(`${a}last_report`,{at:Date.now(),mode:"admin",totalUrls:s.length}),t("admin preload complete",{totalUrls:s.length}),!0},f=async()=>{if(n)return;if(e.dailyOnce&&c())return void t("already ran today");n=!0;const r=async()=>{try{await h(),e.dailyOnce&&i(l,!0)}finally{n=!1,s()}};if(window.elementor&&"function"==typeof elementor.on)if(elementor.previewView&&elementor.previewView.loaded)r();else{const e=()=>{elementor.off("preview:loaded",e),r()};elementor.on("preview:loaded",e)}else r()};window.AAE_forcePreload=()=>{n=!1,f()},window.AAE_forcePreload()});