!function(e){"use strict";class t{constructor(){this.init(),this.templateCache=new Map}init(){e(window).on("elementor:init",()=>{this.onElementorInit()})}onElementorInit(){this.bindEvents(),this.initializePreviewSystem(),elementor.hooks.addAction("panel/open_editor/widget/aae--loop-grid",(e,t,a)=>{this.onWidgetPanelOpen(e,t,a)}),elementor.hooks.addAction("panel/open_editor/widget/aae--loop-carousel",(e,t,a)=>{this.onWidgetPanelOpen(e,t,a)})}bindEvents(){e(document).on("change",".elementor-control-template_id select",e=>{this.handleTemplateChange(e)}),elementor.channels.data.on("change",this.onElementorSettingChange.bind(this))}onWidgetPanelOpen(e,t,a){setTimeout(()=>{this.initializeWidgetControls(t)},100)}onElementorSettingChange(e){"aae--loop-grid"!==e.get("widgetType")&&"aae--loop-carousel"!==e.get("widgetType")||this.handleWidgetSettingChange(e)}handleWidgetSettingChange(e){e.get("settings").get("template_id")&&this.refreshWidgetPreview(e)}initializePreviewSystem(){"undefined"!=typeof elementor&&elementor.modules&&elementor.modules.layouts&&this.setupPreviewHooks()}setupPreviewHooks(){elementor.on("preview:loaded",()=>{this.onPreviewLoaded()}),elementor.channels.editor.on("change:preview:mode",e=>{"preview"===e&&this.refreshAllLoopWidgets()})}onPreviewLoaded(){e("#elementor-preview-iframe").contents().find(".custom-loop-container").each((t,a)=>{this.initializeLoopWidget(e(a))})}initializeWidgetControls(e){const t=e.get("widgetType");"aae--loop-grid"!==t&&"aae--loop-carousel"!==t||this.addTemplateManagementUI(e)}addTemplateManagementUI(t){const a=e(".elementor-control-template_id");if(a.length&&!a.find(".aae-template-actions").length){const i=e('\n                    <div class="aae-template-actions" style="margin-top: 10px;">\n                        <button type="button" class="elementor-button elementor-button-default aae-create-template">\n                            <i class="eicon-plus"></i> Create Template\n                        </button>\n                        <button type="button" class="elementor-button elementor-button-default aae-edit-template" style="display: none;">\n                            <i class="eicon-edit"></i> Edit Template\n                        </button>\n                    </div>\n                ');a.append(i),this.bindTemplateActions(i,t)}}bindTemplateActions(e,t){e.find(".aae-create-template").on("click",()=>{this.createNewTemplate(t)}),e.find(".aae-edit-template").on("click",()=>{const e=t.get("settings").get("template_id");this.editTemplate(e)})}createNewTemplate(e){elementorCommon.dialogsManager.createWidget("confirm",{id:"aae-create-template-modal",headerMessage:"Create Loop Template",message:"This will save your current work and create a new loop template. Continue?",position:{my:"center center",at:"center center"},strings:{confirm:"Create & Edit",cancel:"Cancel"},onConfirm:()=>{this.processTemplateCreation(e)}}).show()}processTemplateCreation(t){Promise.resolve().then(()=>{if(elementor&&elementor.saver&&elementor.saver.save)return elementor.saver.save()}).then(()=>this.doCreateTemplate()).then(a=>{if(a.success){t.get("settings").set("template_id",a.data.template_id);const i=elementor.config.document.id;e(document).trigger("clb:enter-template-mode",{templateId:a.data.template_id,baseId:i})}}).catch(e=>{console.error("Template creation failed:",e),elementor.notifications.showToast({message:"Failed to create template",type:"error"})})}doCreateTemplate(){const t="undefined"!=typeof aaeLoopBuilderTemplateQuery?aaeLoopBuilderTemplateQuery.ajax_url:"/wp-admin/admin-ajax.php",a="undefined"!=typeof aaeLoopBuilderTemplateQuery?aaeLoopBuilderTemplateQuery.nonce:"";return e.ajax({url:t,type:"POST",data:{action:"create_loop_template",template_name:"New Loop Template",source_type:"post",template_type:"loop-builder",nonce:a}})}editTemplate(t){t&&Promise.resolve().then(()=>{if(elementor&&elementor.saver&&elementor.saver.save)return elementor.saver.save()}).finally(()=>{const a=elementor.config.document.id;e(document).trigger("clb:enter-template-mode",{templateId:t,baseId:a})})}refreshWidgetPreview(e){const t=elementor.getPreviewView().getChildViewContainer(e);t&&t.renderHTML()}refreshAllLoopWidgets(){e("#elementor-preview-iframe").contents().find(".custom-loop-container").each((t,a)=>{const i=e(a).closest(".elementor-widget");if(i.length){const e=i.data("id"),t=elementor.getContainer(e);t&&this.refreshWidgetPreview(t)}})}initializeLoopWidget(e){const t=e.data("settings")||{};t.template_id&&this.loadTemplatePreview(t.template_id,e)}handleTemplateChange(t){const a=e(t.target).val(),i=e(".aae-edit-template");a?(i.show(),this.loadTemplatePreview(a)):i.hide()}loadTemplatePreview(t,a=null){if(this.templateCache.has(t)){const e=this.templateCache.get(t);return this.displayTemplatePreview(e,a),Promise.resolve(e)}const i=a||this.getPreviewArea();i.html('<div class="loading">Loading preview...</div>');const n="undefined"!=typeof aaeLoopBuilderTemplateQuery?aaeLoopBuilderTemplateQuery.ajax_url:"/wp-admin/admin-ajax.php",o="undefined"!=typeof aaeLoopBuilderTemplateQuery?aaeLoopBuilderTemplateQuery.nonce:"";return e.ajax({url:n,type:"POST",data:{action:"clb_get_template_preview",template_id:t,nonce:o}}).done(e=>{e.success?(this.templateCache.set(t,e.data),this.displayTemplatePreview(e.data,a)):i.html('<div class="error">Preview not available</div>')}).fail(()=>{i.html('<div class="error">Failed to load preview</div>')})}displayTemplatePreview(e,t=null){const a=t||this.getPreviewArea();let i='<div class="template-preview">';i+='<h4><i class="eicon-document-file"></i> Template Preview</h4>',e.template_data&&Array.isArray(e.template_data)?(i+='<div class="widget-list">',e.template_data.forEach(e=>{if(e.widgetType){const t=this.getWidgetIcon(e.widgetType);i+=`<div class="widget-preview">\n                            <i class="${t}"></i> ${this.getWidgetLabel(e.widgetType)}\n                        </div>`}}),i+="</div>"):i+='<div class="empty-template">Empty template - add some widgets to get started</div>',i+="</div>",a.html(i)}getWidgetIcon(e){return{heading:"eicon-heading","text-editor":"eicon-text",image:"eicon-image",button:"eicon-button",divider:"eicon-divider",spacer:"eicon-spacer",icon:"eicon-star","icon-list":"eicon-bullet-list"}[e]||"eicon-apps"}getWidgetLabel(e){return{heading:"Heading","text-editor":"Text Editor",image:"Image",button:"Button"}[e]||e.replace("-"," ").replace(/\b\w/g,e=>e.toUpperCase())}getPreviewArea(){let t=e(".template-preview-container");return t.length||(t=e('<div class="template-preview-container"></div>'),e(".elementor-control-template_id").after(t)),t}clearTemplateCache(e=null){e?this.templateCache.delete(e):this.templateCache.clear()}}e(document).ready(()=>{"undefined"!=typeof elementor?new t:e(window).on("elementor:init",()=>{new t})})}(jQuery);