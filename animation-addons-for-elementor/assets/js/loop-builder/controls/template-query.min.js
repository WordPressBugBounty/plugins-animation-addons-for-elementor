!function(e){"use strict";class t extends elementor.modules.controls.Select2{getDefaultSettings(){const e=super.getDefaultSettings();return{...e,select2Options:{...e.select2Options,placeholder:"Select Template",allowClear:!0}}}getSelect2Placeholder(){return{id:"",text:"Select Template"}}onReady(){super.onReady(),this.initTemplateActions(),this.updateActionButtons()}initTemplateActions(){const e=this.$el.find(".elementor-control-template-query-actions");e.on("click",'[data-action="new"]',e=>{e.preventDefault(),this.createNewTemplate()}),e.on("click",'[data-action="edit"]',e=>{e.preventDefault(),this.editTemplate()})}onBaseInputChange(){super.onBaseInputChange(...arguments),this.updateActionButtons()}updateActionButtons(){const e=this.getControlValue(),t=this.$el.find(".elementor-control-template-query-actions"),o=t.find('[data-action="edit"]'),a=t.find('[data-action="new"]'),n=this.$el.find(".elementor-control-template_query-empty-state");e?(o.show(),a.hide(),n.hide()):(o.hide(),a.show(),n.show())}createNewTemplate(){this.getCreateTemplateDialog().show()}getCreateTemplateDialog(){return this.createTemplateDialog||(this.createTemplateDialog=elementorCommon.dialogsManager.createWidget("confirm",{id:"aae-loop-builder-create-template",headerMessage:"Create Template",message:"Creating a new template will save your current work and switch to the template editor. Continue?",position:{my:"center center",at:"center center"},strings:{confirm:"Create & Switch",cancel:"Cancel"},onConfirm:()=>{this.saveAndCreateTemplate()}})),this.createTemplateDialog}saveAndCreateTemplate(){const e=this.$el.find('[data-action="new"]'),t=e.html();e.html('<i class="eicon-loading eicon-animation-spin"></i> Creating...').prop("disabled",!0),this.saveCurrentPage().then(()=>this.doCreateTemplate()).catch(e=>{console.error("Save and create failed:",e),elementor.notifications.showToast({message:"Failed to save current work",type:"error"})}).finally(()=>{e.html(t).prop("disabled",!1)})}saveCurrentPage(){return new Promise((e,t)=>{if(this.hasUnsavedChanges()){if("undefined"!=typeof $e&&$e.components){const o=$e.components.get("document/save");if(o&&o.saveDraft)return void o.saveDraft().then(()=>{elementor.notifications.showToast({message:"Current work saved successfully!",type:"success"}),e()}).catch(e=>{console.error("Save failed:",e),t(e)})}"undefined"!=typeof elementor&&elementor.saver&&elementor.saver.saveDraft?elementor.saver.saveDraft().then(()=>{elementor.notifications.showToast({message:"Current work saved successfully!",type:"success"}),e()}).catch(e=>{console.error("Save failed:",e),t(e)}):(console.warn("No save method available"),e())}else e()})}hasUnsavedChanges(){if("undefined"!=typeof $e&&$e.components){const e=$e.components.get("document/save");if(e&&e.isEditorChanged)return e.isEditorChanged()}return!("undefined"==typeof elementor||!elementor.saver||!elementor.saver.isEditorChanged)&&elementor.saver.isEditorChanged()}doCreateTemplate(){return"undefined"!=typeof aaeLoopBuilderTemplateQuery&&aaeLoopBuilderTemplateQuery.ajax_url?new Promise((t,o)=>{const a=this.getSourceType();e.ajax({url:aaeLoopBuilderTemplateQuery.ajax_url,type:"POST",data:{action:"create_loop_template",nonce:aaeLoopBuilderTemplateQuery.nonce,template_name:"New Loop Template",source_type:a,template_type:"loop-builder"}}).done(e=>{if(e.success){const o=this.$el.find("select"),a=new Option(e.data.template_name,e.data.template_id,!0,!0);o.append(a).trigger("change"),this.setValue(e.data.template_id),this.updateActionButtons(),elementor&&elementor.notifications&&elementor.notifications.showToast({message:"Template created successfully!",type:"success"}),t(e.data)}else{const t=e.data||"Template creation failed";console.error("Template creation error:",t),elementor.notifications.showToast({message:t,type:"error"}),o(t)}}).fail(e=>{console.error("Template creation failed:",e);const t=e.responseJSON&&e.responseJSON.data?e.responseJSON.data:"Failed to create template. Please try again.";elementor.notifications.showToast({message:t,type:"error"}),o(e)})}):(console.error("AAE Loop Builder Template Query variables not available"),elementor.notifications.showToast({message:"Editor not properly initialized",type:"error"}),Promise.reject("Variables not available"))}editTemplate(){const e=this.getControlValue();if(e){const t=this.$el.find('[data-action="edit"]'),o=t.html();t.html('<i class="eicon-loading eicon-animation-spin"></i> Loading...').prop("disabled",!0),this.saveCurrentDocument().then(()=>{this.switchToTemplateDocumentWithoutReload(e)}).catch(t=>{console.error("Save failed:",t),this.switchToTemplateDocumentWithoutReload(e)}).finally(()=>{setTimeout(()=>{t.html(o).prop("disabled",!1)},500)})}}switchToTemplateDocumentWithoutReload(t){elementor&&elementor.notifications&&elementor.notifications.showToast({message:"Switching to template editor...",type:"info"});const o=elementor.config.document?elementor.config.document.id:null;this.performDocumentSwitch(t).then(()=>{const a=new URL(window.location.href);a.searchParams.set("active-document",String(t)),window.history.replaceState({},"",a.toString()),e(document).trigger("clb:enter-template-mode",{templateId:t,baseId:o}),elementor&&elementor.notifications&&elementor.notifications.showToast({message:"Template editor loaded",type:"success"})}).catch(e=>{console.error("No-reload switch failed, using page reload:",e),this.openTemplateEditorWithReload(t)})}performDocumentSwitch(e){return new Promise((t,o)=>{try{window.$e&&$e.run?$e.run("editor/documents/switch",{id:parseInt(e)}).then(()=>{t()}).catch(e=>{o(e)}):o("Modern API not available")}catch(e){console.error("Perform switch error:",e),o(e)}})}openTemplateEditorWithReload(e){const t=elementor.config.document.id,o=`${window.location.origin}/wp-admin/post.php?post=${t}&action=elementor&active-document=${e}`;setTimeout(()=>{window.location.href=o},300)}saveCurrentDocument(){return new Promise((e,t)=>{try{if(window.$e&&$e.components){const t=$e.components.get("document/save");if(t&&t.save)return void t.save({status:"publish"}).then(()=>{e()}).catch(t=>{e()})}if(elementor&&elementor.saver&&elementor.saver.save)return void Promise.resolve(elementor.saver.save({status:"publish"})).then(()=>{e()}).catch(t=>{e()});console.warn("No save method available, continuing anyway"),e()}catch(t){console.error("Save document error:",t),e()}})}getSourceType(){try{if(this.container&&this.container.model){const e=this.container.model.get("settings");if(e&&e.source)return e.source}return"post"}catch(e){return console.warn("Could not determine source type, using default:",e),"post"}}applySavedValue(){super.applySavedValue(),this.updateActionButtons()}}"undefined"!=typeof elementor?elementor.addControlView("template_query",t):e(window).on("elementor:init",()=>{elementor.addControlView("template_query",t)})}(jQuery);