!function(e){"use strict";e.fn.imagesLoaded=function(e){const o=this.find("img");let t=0;const n=o.length;return 0===n?(e&&e(),this):(o.each(function(){const o=new Image;o.onload=o.onerror=()=>{t++,t===n&&e&&e()},o.src=this.src}),this)};const o=new class{constructor(){this.debug=!1,this.init()}log(e,o=null){this.debug&&console&&console.log}init(){this.log("Initializing AAE Loop Builder"),e(document).ready(()=>{this.log("Document ready"),this.initLoopGrids(),this.initEventHandlers()}),e(window).on("elementor/frontend/init",()=>{this.log("Elementor frontend init"),this.initElementorIntegration()})}initLoopGrids(){const o=e(".custom-loop-container");this.log("Found loop containers:",o.length),o.each((o,t)=>{this.initLoopGrid(e(t))})}initLoopGrid(e){const o=e.data("settings")||{};this.log("Initializing loop grid",o),e.hasClass("custom-loop-masonry")&&this.initMasonry(e),this.initPagination(e,o),"infinite_scroll"===o.pagination_type&&(this.log("Initializing infinite scroll"),this.initInfiniteScroll(e,o))}initMasonry(o){const t=o.find(".e-loop-item"),n=parseInt(o.css("--grid-columns")||3);n<=1||(o.imagesLoaded(()=>{this.arrangeMasonryItems(o,t,n)}),e(window).on("resize",this.debounce(()=>{this.arrangeMasonryItems(o,t,n)},250)))}arrangeMasonryItems(o,t,n){const i=new Array(n).fill(0),a=parseInt(o.css("--grid-row-gap"))||20;t.each((o,t)=>{const n=e(t),s=i.indexOf(Math.min(...i));n.css({"grid-column":s+1,"grid-row-start":Math.floor(i[s]/a)+1}),i[s]+=n.outerHeight()+a})}initPagination(o,t){const n=o.closest(".custom-loop-wrapper"),i=o.closest(".elementor-widget-aae--loop-grid");this.log("Initializing pagination",{pagination_type:t.pagination_type,pagination_load_type:t.pagination_load_type,wrapper_found:n.length>0,widget_found:i.length>0}),n.on("click",".custom-loop-load-more",n=>{n.preventDefault(),this.log("Load more clicked"),this.handleLoadMore(e(n.currentTarget),o,t)}),"ajax"===t.pagination_load_type&&(this.log("Setting up AJAX pagination"),n.on("click",".custom-loop-pagination a, .custom-loop-pagination-wrapper a, .page-numbers a",n=>{n.preventDefault(),n.stopPropagation();const i=e(n.currentTarget).attr("href"),a=this.extractPageFromUrl(i);this.log("AJAX pagination link clicked",{href:i,page:a}),this.loadPage(o,t,a)}))}handleLoadMore(o,t,n){if(o.hasClass("loading")||o.prop("disabled"))return;const i=parseInt(o.data("page")),a=parseInt(o.data("max-page"));this.log("Load more",{page:i,maxPage:a}),i>a?o.hide():(o.addClass("loading").prop("disabled",!0),o.find(".custom-loop-load-more-text").hide(),o.find(".custom-loop-loading-text").show(),this.loadMorePosts(t,n,i).then(n=>{if(this.log("Load more response:",n),n.success&&n.data.html){const i=e(n.data.html);i.addClass("new-item"),t.append(i),this.log("Appended items:",i.length),n.data.has_more?(o.data("page",n.data.next_page),o.removeClass("loading").prop("disabled",!1),o.find(".custom-loop-loading-text").hide(),o.find(".custom-loop-load-more-text").show(),this.log("More items available, next page:",n.data.next_page)):(o.fadeOut(),this.log("No more items to load")),t.hasClass("custom-loop-masonry")&&this.initMasonry(t),t.trigger("aae-loop-builder:itemsLoaded",[i])}else this.log("No HTML in load more response",n),o.removeClass("loading").prop("disabled",!1),o.find(".custom-loop-loading-text").hide(),o.find(".custom-loop-load-more-text").show()}).catch(e=>{console.error("[AAE Loop Builder] Load more failed:",e),o.removeClass("loading").prop("disabled",!1),o.find(".custom-loop-loading-text").hide(),o.find(".custom-loop-load-more-text").show()}))}initInfiniteScroll(o,t){let n=!1,i=(t.paged||1)+1;const a=()=>{if(n)return;const s=o.offset().top+o.outerHeight();e(window).scrollTop()+e(window).height()>=s-200&&(n=!0,o.find(".infinite-scroll-loading").length||o.append('<div class="infinite-scroll-loading" style="text-align:center;padding:20px;"><i class="eicon-loading eicon-animation-spin" style="font-size:24px;color:#007cba;"></i></div>'),this.loadMorePosts(o,t,i).then(t=>{if(o.find(".infinite-scroll-loading").remove(),t.success&&t.data.html){const s=e(t.data.html);s.addClass("new-item"),o.append(s),t.data.has_more?(i++,n=!1,o.hasClass("custom-loop-masonry")&&this.initMasonry(o)):(e(window).off("scroll",a),o.append('<div class="infinite-scroll-end" style="text-align:center;padding:20px;color:#999;">No more items to load</div>')),o.trigger("aae-loop-builder:itemsLoaded",[s])}else n=!1}).catch(e=>{console.error("Infinite scroll failed:",e),o.find(".infinite-scroll-loading").remove(),n=!1}))};e(window).on("scroll",this.debounce(a,150))}loadMorePosts(o,t,n){const i="undefined"!=typeof wcf_addons_frontend?wcf_addons_frontend.ajax_url:"/wp-admin/admin-ajax.php",a=t.nonce||("undefined"!=typeof wcf_addons_frontend?wcf_addons_frontend.nonce:"");return this.log("Load more posts AJAX",{url:i,page:n,nonce:a?"present":"missing"}),e.ajax({url:i,type:"POST",data:{action:"clb_load_more",nonce:a,settings:t,page:n}})}loadPage(o,t,n){this.log("Loading page:",n),o.addClass("ajax-loading");const i={...t,paged:n},a="undefined"!=typeof wcf_addons_frontend?wcf_addons_frontend.ajax_url:"/wp-admin/admin-ajax.php",s=t.nonce||("undefined"!=typeof wcf_addons_frontend?wcf_addons_frontend.nonce:"");return this.log("AJAX request",{url:a,page:n,nonce:s?"present":"missing"}),e.ajax({url:a,type:"POST",data:{action:"clb_load_page",nonce:s,settings:i,page:n}}).then(n=>{if(this.log("AJAX response:",n),n.success&&n.data.html){o.find(".e-loop-item").remove(),o.removeClass("ajax-loading");const i=e(n.data.html);if(o.append(i),this.log("Items loaded:",i.length),n.data.pagination){const e=o.closest(".custom-loop-wrapper"),i=e.find(".custom-loop-pagination-wrapper");i.length?(i.html(n.data.pagination),this.log("Pagination updated")):e.append('<div class="custom-loop-pagination-wrapper">'+n.data.pagination+"</div>"),this.initPagination(o,t)}e("html, body").animate({scrollTop:o.offset().top-100},500),o.hasClass("custom-loop-masonry")&&this.initMasonry(o)}else this.log("No HTML in response",n),o.removeClass("ajax-loading")}).catch(e=>{console.error("[AAE Loop Builder] Page load failed:",e),o.removeClass("ajax-loading")})}extractPageFromUrl(e){if(!e)return 1;if(e.startsWith("?")||e.startsWith("#")){let o=e.match(/[?&]paged=(\d+)/);if(o)return parseInt(o[1]);if(o=e.match(/[?&]page=(\d+)/),o)return parseInt(o[1])}let o=e.match(/[?&]paged=(\d+)/);if(o)return parseInt(o[1]);if(o=e.match(/[?&]page=(\d+)/),o)return parseInt(o[1]);if(o=e.match(/\/page\/(\d+)\//),o)return parseInt(o[1]);if(o=e.match(/\/page\/(\d+)$/),o)return parseInt(o[1]);if(e.includes("#")){const t=e.split("#")[1];if(t&&(o=t.match(/page\/(\d+)/),o))return parseInt(o[1])}return 1}initEventHandlers(){e(document).on("click",".custom-loop-empty-view__button",o=>{o.preventDefault(),this.handleCreateTemplate(e(o.currentTarget))})}handleCreateTemplate(e){"undefined"!=typeof elementor&&elementor.config}initElementorIntegration(){"undefined"!=typeof elementorFrontend?(this.log("Registering Elementor hooks"),elementorFrontend.hooks.addAction("frontend/element_ready/aae--loop-grid.default",e=>{this.log("Loop grid widget ready");const o=e.find(".custom-loop-container");o.length?this.initLoopGrid(o):this.log("Warning: Loop container not found in scope")}),elementorFrontend.hooks.addAction("frontend/element_ready/aae--loop-carousel.default",e=>{this.log("Loop carousel widget ready");const o=e.find(".custom-loop-carousel");o.length&&this.initLoopCarousel(o)})):this.log("Elementor frontend not available")}initLoopCarousel(e){if("undefined"==typeof Swiper)return void console.warn("Swiper is required for carousel functionality");const o=e.data("settings")||{},t={slidesPerView:parseInt(o.slides_to_show)||3,slidesPerGroup:parseInt(o.slides_to_scroll)||1,spaceBetween:20,loop:!1!==o.infinite,speed:parseInt(o.speed)||500,autoplay:!!o.autoplay&&{delay:parseInt(o.autoplay_speed)||3e3,pauseOnMouseEnter:!1!==o.pause_on_hover},navigation:!!o.show_arrows&&{nextEl:e.find(".swiper-button-next")[0],prevEl:e.find(".swiper-button-prev")[0]},pagination:!!o.show_dots&&{el:e.find(".swiper-pagination")[0],clickable:!0},breakpoints:{320:{slidesPerView:1,slidesPerGroup:1},768:{slidesPerView:Math.min(2,parseInt(o.slides_to_show)||3),slidesPerGroup:1},1024:{slidesPerView:parseInt(o.slides_to_show)||3,slidesPerGroup:parseInt(o.slides_to_scroll)||1}}};new Swiper(e[0],t)}debounce(e,o){let t;return function(...n){clearTimeout(t),t=setTimeout(()=>{clearTimeout(t),e(...n)},o)}}};window.AAE_LoopBuilder=o,window.aaeEnableLoopDebug=function(){o.debug=!0,document.body.classList.add("aae-loop-debug")},window.aaeDisableLoopDebug=function(){o.debug=!1,document.body.classList.remove("aae-loop-debug")}}(jQuery);