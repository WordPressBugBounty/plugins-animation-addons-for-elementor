!function(e){"use strict";class t{constructor(){this.activeDocumentId=null,this.baseDocumentId=null,this.isTemplateMode=!1,this.init()}init(){e(document).on("clb:enter-template-mode",(e,t)=>{t&&t.templateId&&this.enterTemplateMode(t.templateId,t.baseId)});const t=new URLSearchParams(window.location.search),o=t.get("active-document");if(o){const e=parseInt(t.get("post"));this.waitForElementor(()=>{this.enterTemplateMode(parseInt(o),e)})}}waitForElementor(e){"undefined"!=typeof elementor&&elementor.config?e():setTimeout(()=>this.waitForElementor(e),100)}enterTemplateMode(e,t){this.activeDocumentId=e,this.baseDocumentId=t||(elementor.config.document?elementor.config.document.id:null),this.isTemplateMode=!0;const o=new URL(window.location.href);o.searchParams.set("active-document",String(e)),window.history.replaceState({},"",o.toString()),this.addEditorIndicatorWithControls(),this.lockBaseDocument(),this.switchToTemplateDocument()}addEditorIndicatorWithControls(){e(".aae-template-mode-bar").remove();const t=()=>{const o=document.querySelector("#elementor-preview-iframe");if(!o||!o.contentWindow||!o.contentDocument)return void setTimeout(t,300);const n=jQuery(o.contentDocument),i=new URLSearchParams(window.location.search).get("active-document")||null;if(null==i)return void setTimeout(t,300);const r=n.find(".custom-loop-container-"+i);if(!r.length)return void setTimeout(t,300);const a=r.find(".aae-loop-item:first-child");if(a.length&&!a.find(".aae-inline-back-btn").length){a.css({border:"1px dashed rgba(241, 37, 41, 1)",position:"relative"});const e=jQuery('<button class="aae-inline-back-btn">‚Üê Save & Back</button>').css({position:"absolute",top:"-27px",left:"50%",transform:"translateX(-50%)",background:"linear-gradient(225deg, #F12529 10.04%, #FFA030 90.11%)",color:"#fff",border:"0","border-radius":"4px",padding:"4px 8px","font-size":"12px",cursor:"pointer","z-index":"10"});e.on("click",()=>this.saveAndExitTemplateMode()),a.append(e)}e("body").addClass("aae-template-editing-mode")};t()}lockBaseDocument(){const t=e("#elementor-preview-iframe");if(!t.length)return;const o=t[0].contentDocument;if(!o)return;const n="aae-lock-base-style";if(o.getElementById(n))return;const i=new URLSearchParams(window.location.search).get("active-document")||null,r=o.createElement("style");r.id=n,r.textContent=`\n                /* Lock base page elements - no visual effects, just disable interaction */\n                .elementor-element:not(.e-loop-item):not(.e-loop-item *) {\n                    pointer-events: none !important;\n                }\n                \n                /* Keep template area fully interactive */\n                .e-loop-item,\n                .e-loop-item *,\n                .e-loop-item .elementor-element {\n                    pointer-events: auto !important;\n                }\n                \n                /* Enable Add Section buttons inside loop container */\n                .custom-loop-container-${i} .elementor-add-section, .custom-loop-container-${i} .elementor-empty-view, .custom-loop-container-${i} .elementor-widget-empty {\n                    display: block !important;\n                }\n                .custom-loop-container-${i} .elementor-element-editable .elementor-element-overlay {\n                    display: block !important;\n                }\n                .custom-loop-container-${i} .elementor-element.elementor-element-edit-mode:hover .elementor-element-overlay {\n                    display: block !important;\n                    pointer-events: none !important;\n                }\n            `,o.head.appendChild(r)}switchToTemplateDocument(){setTimeout(()=>{try{if(elementor&&elementor.getPanelView){const e=elementor.getPanelView();e&&e.setPage&&e.setPage("elements")}else elementor&&elementor.panels&&elementor.panels.currentView?elementor.panels.currentView.setPage("elements"):window.$e&&window.$e.route&&$e.route("panel/editor")}catch(e){console.warn("Could not open elements panel:",e)}},500)}saveAndExitTemplateMode(){elementor&&elementor.notifications&&elementor.notifications.showToast({message:"Saving template...",type:"info"}),this.saveDocument().then(()=>{elementor&&elementor.notifications&&elementor.notifications.showToast({message:"Template saved successfully!",type:"success"}),this.exitTemplateMode()}).catch(e=>{console.error("Save failed:",e),this.exitTemplateMode()})}saveDocument(){return new Promise((e,t)=>{try{if("undefined"!=typeof $e&&$e.components){const o=$e.components.get("document/save");if(o&&o.save)return void o.save({status:"publish"}).then(e).catch(t)}if("undefined"!=typeof elementor&&elementor.saver&&elementor.saver.save)return void Promise.resolve(elementor.saver.save({status:"publish"})).then(e).catch(t);console.warn("No save method available, resolving anyway"),e()}catch(e){console.error("Save document error:",e),t(e)}})}exitTemplateMode(){const e=this.baseDocumentId||(elementor.config.initial_document?elementor.config.initial_document.id:null);if(!e)return console.error("Base document ID not found, using fallback"),void this.fallbackExit();elementor&&elementor.notifications&&elementor.notifications.showToast({message:"Returning to page editor...",type:"info"}),this.switchDocumentWithoutReload(e).catch(e=>{console.warn("Document switch failed, using page reload:",e),elementor&&elementor.notifications&&elementor.notifications.showToast({message:"Reloading editor...",type:"info"}),setTimeout(()=>{this.fallbackExit()},800)})}switchDocumentWithoutReload(e){return new Promise((t,o)=>{try{if(!this.isPreviewReady())return console.warn("Preview not ready, using fallback"),void o("Preview not ready");if(window.$e&&$e.run)if($e.components&&$e.components.get("document")){const n=$e.components.get("document");n.save?n.save().then(()=>this.performDocumentSwitch(e,t,o)).catch(()=>this.performDocumentSwitch(e,t,o)):this.performDocumentSwitch(e,t,o)}else this.performDocumentSwitch(e,t,o);else o("Modern API not available")}catch(e){console.error("Switch without reload error:",e),o(e)}})}isPreviewReady(){try{const t=e("#elementor-preview-iframe");if(!t.length)return!1;const o=t[0];if(!o||!o.contentWindow||!o.contentDocument)return!1;const n=o.contentWindow;return n.jQuery&&"function"==typeof n.jQuery?!!n.elementorFrontend||(console.warn("elementorFrontend not initialized"),!1):(console.warn("Preview jQuery not initialized"),!1)}catch(e){return console.warn("Preview ready check failed:",e),!1}}performDocumentSwitch(e,t,o){try{setTimeout(()=>{if(!this.isPreviewReady())return console.error("Preview became unavailable, falling back to page reload"),void o("Preview unavailable");$e.run("editor/documents/switch",{id:parseInt(e)}).then(()=>{this.completeExitWithoutReload(),t()}).catch(e=>{console.error("Document switch failed:",e),o(e)})},300)}catch(e){console.error("Perform switch error:",e),o(e)}}completeExitWithoutReload(){const e=new URL(window.location.href);e.searchParams.delete("active-document"),window.history.replaceState({},"",e.toString()),this.cleanup(),elementor&&elementor.notifications&&elementor.notifications.showToast({message:"Returned to page editor",type:"success"}),setTimeout(()=>{elementor&&elementor.reloadPreview?elementor.reloadPreview():window.$e&&$e.run&&$e.run("document/elements/refresh")},100)}fallbackExit(){if(this.cleanup(),this.baseDocumentId){const e=`${window.location.origin}/wp-admin/post.php?post=${this.baseDocumentId}&action=elementor`;console.log("Redirecting to:",e),window.location.href=e}else{console.error("Cannot fallback exit - no base document ID");const e=new URL(window.location.href);e.searchParams.delete("active-document"),window.location.href=e.toString()}}cleanup(){e(".aae-template-mode-bar").remove(),e("body").removeClass("aae-template-editing-mode");const t=e("#elementor-preview-iframe");if(t.length){const e=t[0].contentDocument;if(e){const t=e.getElementById("aae-lock-base-style");t&&t.remove()}}this.isTemplateMode=!1,this.activeDocumentId=null}}e(document).ready(()=>{window.AAE_ActiveDocumentHandler=new t})}(jQuery);